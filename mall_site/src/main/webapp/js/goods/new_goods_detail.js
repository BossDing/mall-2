$(function(){$(".product_comment").click(function(){loadComment(1,3)});$(".product_ask").click(function(){loadCommentAsk(1,null)});$(".cmt_tabs li").click(function(){$(this).addClass("cur").siblings().removeClass("cur");var type=$(this).find("a").attr("data-role");loadComment(1,type)});$(".consult_tabs li").click(function(){$(this).addClass("cur").siblings().removeClass("cur");loadCommentAsk(1,$(this).attr("data-role"))});$(".reply_btn").click(function(){$(this).parent().next(".reply_wp").toggleClass("none")});$(".comment_target").click(function(){$(".product_comment a").click()});if(window.location.href.indexOf("#comment")!=-1){$(".product_comment a").click()}if(window.location.href.indexOf("#consult")!=-1){$(".product_ask a").click()}$(".consult_text").keydown(function(e){if(e.keyCode==13){$(this).parent().find(".cs_search_btn").click()}})});function reply(t){$(t).parent().next(".reply_wp").toggleClass("none")}function reply2(t){$(t).parents(".reply_ct").find(".reply_wp").toggleClass("none")}function r_cmt(t){$(t).parents(".reply_ct").find(".reply_wp").toggleClass("none")}function loadComment(pageNo,type){$(".comment_list").html("");$(".comment_pages").html("");var productId=$("#productId").val();var params="&productId="+productId;params+="&pageNo="+pageNo;var totalCount=0;var haoCount=0;var zhongCount=0;var chaCount=0;$.get("../goods/queryProducCommentForDetail.html?type=3"+params,function(data){totalCount=data.rows;if(type==3){putPageComment(type,data)}$(".allCount").text(totalCount);calcCommentPercent(totalCount,haoCount,zhongCount,chaCount)});$.get("../goods/queryProducCommentForDetail.html?type=0"+params,function(data){haoCount=data.rows;if(type==0){putPageComment(type,data)}$(".haoCount").text(haoCount);calcCommentPercent(totalCount,haoCount,zhongCount,chaCount)});$.get("../goods/queryProducCommentForDetail.html?type=1"+params,function(data){zhongCount=data.rows;if(type==1){putPageComment(type,data)}$(".zhongCount").text(zhongCount);calcCommentPercent(totalCount,haoCount,zhongCount,chaCount)});$.get("../goods/queryProducCommentForDetail.html?type=2"+params,function(data){chaCount=data.rows;if(type==2){putPageComment(type,data)}$(".chaCount").text(chaCount);calcCommentPercent(totalCount,haoCount,zhongCount,chaCount)})}function putPageComment(type,data){var commentHtml="";if(data.list!=null&&data.list.length>0){for(var l=0;l<data.list.length;l++){var comment=data.list[l];commentHtml+="<div class='comment_box clearfix'>"+"<div class='cmt_user mt20 fl'>"+"<a class='user_img' href='javascript:;'><img alt='' ";if(comment.customerImg!=null&&comment.customerImg!=""){commentHtml+=" src="+comment.customerImg}else{commentHtml+=" src='../images/user_img.gif'"}commentHtml+=" width='54' height='54' /></a>"+"<p class='uname'><a href='javascript:;'>"+comment.customerNickname+"</a></p></div><!--/cmt_user--><div style='margin-left: 10px; margin-top:30px;' class='star_wp fl'>"+"<span class='star star_"+parseFloat(comment.commentScore).toFixed(0)+"_0'></span></div>";commentHtml+="<div class='x-model fl'> </div>";commentHtml+="<div class='cmt_main fr'>";commentHtml+="<div class='cmt-det'> "+comment.commentContent+"</div>";commentHtml+="<div class='clearfix'> <span class='buy_date'>"+timeStamp2String(comment.buyTime)+"</span> </div> <div class='cmt_content mt10'>";commentHtml+="<div class='clearfix'>";if(null!=comment.imageList&&comment.imageList.length>0){commentHtml+=" <ul class='od_list clearfix'>";for(var i=0;i<comment.imageList.length;i++){commentHtml+="<li data-img="+comment.imageList[i].imageName+"><a href='javascript:;'><img alt='' src="+comment.imageList[i].imageName+" width='60' height='60' /></a>"+"<b></b></li>"}commentHtml+="</ul><!--/od_list--><div class='photo_viewer'><img alt='' src='' /></div><!--/photo_viewer-->"}commentHtml+="</div>";commentHtml+=" <div class='clearfix'> ";if(comment.commentTag!=null){commentHtml+="<ul class='rec_points clearfix'> ";var tags=comment.commentTag.split(",");for(var i=0;i<tags.length;i++){commentHtml+="<li>"+tags[i]+"</li>"}commentHtml+="</ul>"}commentHtml+="</div>";commentHtml+="<div class='tl'><a class='reply_btn' onclick='reply(this)' href='javascript:;'>回复(";if(null!=comment.replays&&comment.replays.length>0){commentHtml+=comment.replays.length}else{commentHtml+="0"}commentHtml+=")</a></div>";commentHtml+="<div class='reply_wp mt10 clearfix none'><div class='arrow'><em>◆</em><span>◆</span>"+"</div><!--/arrow--><div class='reply_cont'>回复：<div class='reply_input mt5 clearfix'>"+"<input style='width:380px' class=' reply_txa fl replay_txa_"+comment.commentId+"'/><input class='replyBtn fr' type='button' onclick='upReplay(this)' data-comment="+comment.commentId+" value='回复' />"+"</div><!--/reply_input--></div><!--/reply_cont--></div><!--/reply_wp-->";commentHtml+="</div><!--/cmt_content--></div><!--/cmt_main-->";if(null!=comment.replays&&comment.replays.length>0){for(var i=0;i<comment.replays.length;i++){commentHtml+="<div class='cb'></div><div class='reply_list mt20'><div class='reply_ct'><div class='clearfix'><strong class='fl'>"+parseFloat(parseFloat(i)+parseFloat(1))+"</strong>"+" <div class='rp_wp fl ml10'> <div class='rp_con lh150'><span class='rp-name'><a href='javascript:;'>"+comment.replays[i].customerNickname+"</a>回复<a href='javascript:;'>"+comment.customerNickname+"</a>：</span><span class='rp_ct'>"+comment.replays[i].commentContent+"</span>"+"</div><!--/rp_con--><div class='clearfix mt10'><span class='fl ml5'>"+timeStamp2String(comment.replays[i].publishTime)+"</span><!--<a class='rp_btn rp_type fr mr10' href='javascript:;' onclick=reply2(this)>回复</a>--></div>"+"</div><!--/rp_wp--></div>";
    commentHtml+="<div class='reply_wp mt10 clearfix none'> <div class='arrow'> <em>◆</em> <span>◆</span> "+"</div><!--/arrow--> <div class='reply_cont'>回复： <div class='reply_input mt5 clearfix'>"+" <textarea class='reply_txa fl'></textarea> <input class='replyBtn fr' type='button' "+"value='回复'> </div><!--/reply_input--> </div><!--/reply_cont--> </div></div><!--/reply_ct--></div><!--/reply_list-->"}}commentHtml+="</div><!--/comment_box-->"}var paging="";var pageNo=0;if((data.pageNo-2)>0){pageNo=(data.pageNo-2)}else{pageNo=data.firstPageNo}var endNo=0;if((data.lastPageNo-1)>0){endNo=(data.lastPageNo-2)}else{endNo=1}if(data.pageNo==1){paging+="<a class='nono' href='javascript:void(0);'>上一页</a>"}else{paging+="<a class='pg_prev' ";if(data.nextPageNo>0){paging+="onClick='loadComment("+data.prePageNo+","+type+");'"}paging+=" href='javascript:;'>上一页</a>";if(data.pageNo>=4){paging+="<a class='num' href='javascript:void(0)' onClick='loadComment("+data.prePageNo+","+type+");'>"+data.firstPageNo+"</a>"}}if((data.pageNo-3)>1){paging+="<span class='ellipsis'>...</span>"}var no_index=0;for(var i=pageNo;i<=data.endNo;i++){if(no_index<=4){if(i==data.pageNo){paging+="<a class='num_cur prev' href='javascript:void(0);'>"+i+"</a>"}else{paging+="<a class='num' href='javascript:void(0);' onClick='loadComment("+i+","+type+");'>"+i+"</a>"}}no_index++}if(data.pageNo!=data.lastPageNo){if((data.lastPageNo-data.pageNo)>3){if(data.lastPageNo){paging+="<span class='ellipsis'>...</span>"}}}if((data.pageNo==data.lastPageNo||data.endNo<=1)){if(data.lastPageNo>data.pageNo){paging+="<a class='num_cur' href='javascript:void(0);'>"+data.lastPageNo+"</a>"}paging+="<a class='nono' href='javascript:void(0);'>下一页</a>"}else{if((data.lastPageNo-data.pageNo)>=3){if(data.lastPageNo>5){paging+="<a class='num' href='javascript:void(0);' onClick='loadComment("+data.lastPageNo+","+type+");' >"+data.lastPageNo+"</a>"}}paging+="<a class='pg_next' href='javascript:void(0);'";if(data.nextPageNo>0){paging+=" onClick='loadComment("+data.nextPageNo+","+type+");'"}paging+=" >下一页</a>"}$(".comment_pages").html(paging);$(".all_cmt").show()}else{commentHtml+="<div ><p style='margin-bottom:2px;'>暂无商品评价！</p><span>只有购买过该商品的用户才能进行评价。</span></div>";$(".all_cmt").hide()}$(".comment_list").html(commentHtml);var spec=$(".chooseParamId");var html="";if(null!=spec&&spec.length>0){for(var i=0;i<spec.length;i++){html+="<p><span>"+$(spec[i]).attr("data-spec")+"：</span>"+$(spec[i]).attr("data-detail")+"</p>"}$(".x-model").html(html)}initImgClick();$(".reply_txa").keydown(function(e){if(e.keyCode==13){$(this).parent().find(".replyBtn").click()}})}function initImgClick(){$(".od_list").each(function(){var _this=$(this);_this.find("a").click(function(){if($(this).parent().hasClass("cur")){$(this).parent().removeClass("cur");_this.next(".photo_viewer").hide().width(0).height(0);_this.next(".photo_viewer").find("img").attr("src","").width(0).height(0)}else{var _src=$(this).parent("li").attr("data-img");var img_url=_src+"?"+Date.parse(new Date());var _img=new Image();_img.src=img_url;var nw=_this.next(".photo_viewer").width();var nh=_this.next(".photo_viewer").height();_this.find(".cur").removeClass("cur");$(this).parent("li").addClass("cur");_this.next(".photo_viewer").show().width(nw).height(nh);_this.next(".photo_viewer").find("img").attr("src",_src);_img.onload=function(){var nw=_img.width+8;var nh=_img.height+8;if(nw>490){nw=490}if(nh>430){nh=430}_this.next(".photo_viewer").find("img").animate({width:nw-8,height:nh-8},500);_this.next(".photo_viewer").animate({width:nw,height:nh},500)}}});_this.next(".photo_viewer").click(function(){_this.find(".cur").removeClass("cur");$(this).hide().width(0).height(0);$(this).find("img").attr("src","").width(0).height(0)})})}function loadCommentAsk(pageNo,type){$(".consult_list").html("");var title=$(".consult_text").val();var productId=$("#productId").val();var params="productId="+productId;params+="&pageNo="+pageNo;params+="&title="+title;if(null!=type&&type!=0){params+="&askType="+type}$.get("../goods/queryProducCommentForDetail.html?"+params,function(data){$(".consult_count").html(data.list.length);if(data!=null&&data.list.length>0){var askHtml="";for(var i=0;i<data.list.length;i++){if(data.list[i].isDisplay==1){var ask=data.list[i];askHtml+="<div class='consult_item'><dl class='consult_user clearfix'><dt>网&nbsp;&nbsp;&nbsp;&nbsp;友：</dt>"+"<dd><span class='cs_name'>"+ask.customerNickname+"</span><span class='ml30'>"+timeStamp2String(ask.publishTime)+"</span></dd>"+"</dl><!--/consult_user--><dl class='cs_con clearfix'><dt>咨询内容：</dt><dd><a href='javascript:;'>"+ask.commentContent+"</a></dd></dl><!--/cs_con-->";if(ask.replays!=null&&ask.replays.length>0){for(var j=0;j<ask.replays.length;j++){askHtml+="<dl class='cs_reply clearfix'><dt>客服回复：</dt><dd>"+"<p class='fl'>"+ask.replays[j].commentContent+"</p>"+" <span class='cr_date fr'>"+timeStamp2String(ask.replays[j].publishTime)+"</span></dd></dl><!--/cs_reply-->"}}askHtml+="</div><!--/consult_item-->"}}$(".consult_list").html(askHtml);
    $(".all_consult_tip").show();var paging="";var pageNo=0;if((data.pageNo-2)>0){pageNo=(data.pageNo-2)}else{pageNo=data.firstPageNo}var endNo=0;if((data.lastPageNo-1)>0){endNo=(data.lastPageNo-2)}else{endNo=1}if(data.pageNo==1){paging+="<a class='no_pages pg_prev' href='javascript:void(0);'>上一页</a>"}else{paging+="<a class='pg_prev' ";if(data.nextPageNo>0){paging+="onClick='loadCommentAsk("+data.prePageNo+","+type+");'"}paging+=" href='javascript:;'>上一页</a>";if(data.pageNo>=4){paging+="<a class='num' href='javascript:void(0)' onClick='loadCommentAsk("+data.prePageNo+","+type+");'>"+data.firstPageNo+"</a>"}}if((data.pageNo-3)>1){paging+="<span class='ellipsis'>...</span>"}var no_index=0;for(var i=pageNo;i<=data.endNo;i++){if(no_index<=4){if(i==data.pageNo){paging+="<a class='num_cur prev' href='javascript:void(0);'>"+i+"</a>"}else{paging+="<a class='num' href='javascript:void(0);' onClick='loadCommentAsk("+i+","+type+");'>"+i+"</a>"}}no_index++}if(data.pageNo!=data.lastPageNo){if((data.lastPageNo-data.pageNo)>3){if(data.lastPageNo){paging+="<span class='ellipsis'>...</span>"}}}if((data.pageNo==data.lastPageNo||data.endNo<=1)){if(data.lastPageNo>data.pageNo){paging+="<a class='num_cur' href='javascript:void(0);'>"+data.lastPageNo+"</a>"}paging+="<a class='no_pages pg_next' href='javascript:void(0);'>下一页</a>"}else{if((data.lastPageNo-data.pageNo)>=3){if(data.lastPageNo>5){paging+="<a class='num' href='javascript:void(0);' onClick='loadCommentAsk("+data.lastPageNo+","+type+");' >"+data.lastPageNo+"</a>"}}paging+="<a class='pg_next' href='javascript:void(0);'";if(data.nextPageNo>0){paging+=" onClick='loadCommentAsk("+data.nextPageNo+","+type+");'"}paging+=" >下一页</a>"}$(".cosult_pages").html(paging)}else{$(".consult_list").html("<div class='no_data'><p style='line-height:40px;'>暂无咨询信息！</p></div>");$(".all_consult_tip").hide()}})}function upReplay(obj){var commentId=$(obj).attr("data-comment");var content=$(".replay_txa_"+commentId).val();if(content==null||content==""){$(".info_tip_content2").html("请输入回复内容！");$(".info_tip_img2").attr("src","../images/error.png");$(".info_tip_cancel2").attr("href","javascript:;").hide();$(".info_tip_submit2").attr("href","javascript:;").html("确定").show().unbind("click");$(".info_tip_submit2").click(function(){cls()});dia(2);return}else{if(content.length<10){$(".info_tip_content2").html("回复内容不能小于10个字符！");$(".info_tip_img2").attr("src","../images/error.png");$(".info_tip_cancel2").attr("href","javascript:;").hide();$(".info_tip_submit2").attr("href","javascript:;").html("确定").show().unbind("click");$(".info_tip_submit2").click(function(){cls()});dia(2);return}else{var reg=/^([\u4e00-\u9fa5_A-Za-z0-9 \\`\\~\\!\\@\\#\\$\\^\\&\*\(\)\=\{\}\'\:\;\'\,[\]\.\/\?\~\！\@\#\￥\…\…\&\*\（\）\;\—\|\{\}\【\】\‘\；\：\”\“\'\。\，\、\？])+$/;if(!reg.test(content)){$(".info_tip_content2").html("回复内容不能包含特殊字符！");$(".info_tip_img2").attr("src","../images/error.png");$(".info_tip_cancel2").attr("href","javascript:;").hide();$(".info_tip_submit2").attr("href","javascript:;").html("确定").show().unbind("click");$(".info_tip_submit2").click(function(){cls()});dia(2);return}}}$.post("../goods/uploadCommentReplay.html?replayContent="+content+"&commentId="+commentId,function(data){if(data>=0){var pageNo=$(".comment_pages .num_cur").html();var type=$(".cmt_tabs .cur").find("a").attr("data-role");loadComment(pageNo,type)}else{$(".info_tip_content2").html("是否跳转到登录页?");$(".info_tip_img2").attr("src","../images/index_ques.png");$(".info_tip_cancel2").attr("href","javascript:;").html("取消").show();$(".info_tip_submit2").attr("href","../login.html?item/"+$("#productId").val()).show().html("确定").unbind("click");$(".info_tip_cancel2").click(function(){cls()});dia(2)}})}function calcCommentPercent(totalCount,haoCount,zhongCount,chaCount){var haoPercent=((haoCount/totalCount)*100).toFixed(0);haoPercent=isNaN(haoPercent)?0:haoPercent;var zhongPercent=((zhongCount/totalCount)*100).toFixed(0);zhongPercent=isNaN(zhongPercent)?0:zhongPercent;var chaPercent=((chaCount/totalCount)*100).toFixed(0);chaPercent=isNaN(chaPercent)?0:chaPercent;$(".haoPercent").text(haoPercent+"%");$(".haoPercentLine").width(haoPercent+"%");$(".bigHaoPercent").html(haoPercent+"<em>%</em>");$(".zhongPercent").text(zhongPercent+"%");$(".zhongPercentLine").width(zhongPercent+"%");$(".chaPercent").text(chaPercent+"%");$(".chaPercentLine").width(chaPercent+"%")}function timeStamp2String(time){var date=new Date(parseFloat(time));var datetime=new Date();datetime.setTime(date);var year=datetime.getFullYear();var month=datetime.getMonth()+1<10?"0"+(datetime.getMonth()+1):datetime.getMonth()+1;var date=datetime.getDate()<10?"0"+datetime.getDate():datetime.getDate();var hour=datetime.getHours()<10?"0"+datetime.getHours():datetime.getHours();var minute=datetime.getMinutes()<10?"0"+datetime.getMinutes():datetime.getMinutes();var second=datetime.getSeconds()<10?"0"+datetime.getSeconds():datetime.getSeconds();return year+"-"+month+"-"+date+" "+hour+":"+minute+":"+second};